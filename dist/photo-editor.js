(()=>{"use strict";var t,e={130:(t,e,i)=>{var o=i(265);class n{constructor(){this.logger=new o.Vy("PhotoEditor"),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}async editPhoto(t,e){this.logger.info("Starting photo edit process",{imageUrl:t,options:e});try{const i=await this.loadImage(t),o=this.calculateRotatedDimensions(i.width,i.height,e.rotation||0);this.canvas.width=o.width,this.canvas.height=o.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),e.rotation&&this.applyRotation(e.rotation,i.width,i.height),this.ctx.drawImage(i,0,0),this.ctx.restore(),e.crop&&this.applyCrop(e.crop),await this.applyImageAdjustments(e),e.filter&&"none"!==e.filter&&this.applyFilter(e.filter),e.resize&&await this.applyResize(e.resize);const n=e.resize?.quality||.9,a={originalUrl:t,editedDataUrl:this.canvas.toDataURL("image/jpeg",n),fileName:this.generateFileName(t,e),editOptions:e,timestamp:Date.now()};return this.logger.info("Photo edit completed successfully"),a}catch(t){throw this.logger.error("Failed to edit photo:",t),new Error(`Photo editing failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async autoEnhance(t){this.logger.info("Applying automatic enhancement");const e=await this.loadImage(t),i=await this.analyzeImage(e),o={brightness:i.suggestedBrightness,contrast:i.suggestedContrast,saturation:i.suggestedSaturation,filter:i.suggestedFilter};return this.editPhoto(t,o)}async createVariations(t){return this.logger.info("Creating photo variations"),await Promise.all([{brightness:10,contrast:15,saturation:5},{filter:"vibrant",contrast:10},{filter:"warm",brightness:5},{filter:"cool",contrast:20},{brightness:-5,contrast:25,saturation:-10}].map(e=>this.editPhoto(t,e)))}loadImage(t){return new Promise((e,i)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>e(o),o.onerror=()=>i(new Error("Failed to load image")),o.src=t})}calculateRotatedDimensions(t,e,i){const o=i*Math.PI/180,n=Math.abs(Math.cos(o)),a=Math.abs(Math.sin(o));return{width:Math.ceil(t*n+e*a),height:Math.ceil(t*a+e*n)}}applyRotation(t,e,i){const o=this.canvas.width/2,n=this.canvas.height/2;this.ctx.translate(o,n),this.ctx.rotate(t*Math.PI/180),this.ctx.translate(-e/2,-i/2)}applyCrop(t){const e=this.ctx.getImageData(t.x,t.y,t.width,t.height);this.canvas.width=t.width,this.canvas.height=t.height,this.ctx.clearRect(0,0,t.width,t.height),this.ctx.putImageData(e,0,0)}async applyImageAdjustments(t){if(!t.brightness&&!t.contrast&&!t.saturation)return;const e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),i=e.data,o=2.55*(t.brightness||0),n=((t.contrast||0)+100)/100,a=((t.saturation||0)+100)/100;for(let t=0;t<i.length;t+=4){if(i[t]+=o,i[t+1]+=o,i[t+2]+=o,i[t]=(i[t]-128)*n+128,i[t+1]=(i[t+1]-128)*n+128,i[t+2]=(i[t+2]-128)*n+128,1!==a){const e=.299*i[t]+.587*i[t+1]+.114*i[t+2];i[t]=e+(i[t]-e)*a,i[t+1]=e+(i[t+1]-e)*a,i[t+2]=e+(i[t+2]-e)*a}i[t]=Math.max(0,Math.min(255,i[t])),i[t+1]=Math.max(0,Math.min(255,i[t+1])),i[t+2]=Math.max(0,Math.min(255,i[t+2]))}this.ctx.putImageData(e,0,0)}applyFilter(t){const e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),i=e.data;switch(t){case"blackwhite":this.applyGrayscaleFilter(i);break;case"sepia":this.applySepiaFilter(i);break;case"vintage":this.applyVintageFilter(i);break;case"vibrant":this.applyVibrantFilter(i);break;case"cool":this.applyCoolFilter(i);break;case"warm":this.applyWarmFilter(i)}this.ctx.putImageData(e,0,0)}applyGrayscaleFilter(t){for(let e=0;e<t.length;e+=4){const i=.299*t[e]+.587*t[e+1]+.114*t[e+2];t[e]=i,t[e+1]=i,t[e+2]=i}}applySepiaFilter(t){for(let e=0;e<t.length;e+=4){const i=t[e],o=t[e+1],n=t[e+2];t[e]=Math.min(255,.393*i+.769*o+.189*n),t[e+1]=Math.min(255,.349*i+.686*o+.168*n),t[e+2]=Math.min(255,.272*i+.534*o+.131*n)}}applyVintageFilter(t){for(let e=0;e<t.length;e+=4)t[e]=Math.min(255,1.1*t[e]),t[e+1]=Math.min(255,.9*t[e+1]),t[e+2]=Math.min(255,.8*t[e+2])}applyVibrantFilter(t){for(let e=0;e<t.length;e+=4){const i=Math.max(t[e],t[e+1],t[e+2])>128?1.2:1.1;t[e]=Math.min(255,t[e]*i),t[e+1]=Math.min(255,t[e+1]*i),t[e+2]=Math.min(255,t[e+2]*i)}}applyCoolFilter(t){for(let e=0;e<t.length;e+=4)t[e]=Math.min(255,.9*t[e]),t[e+1]=Math.min(255,1*t[e+1]),t[e+2]=Math.min(255,1.1*t[e+2])}applyWarmFilter(t){for(let e=0;e<t.length;e+=4)t[e]=Math.min(255,1.1*t[e]),t[e+1]=Math.min(255,1.05*t[e+1]),t[e+2]=Math.min(255,.9*t[e+2])}async applyResize(t){const e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),i=document.createElement("canvas"),o=i.getContext("2d");i.width=this.canvas.width,i.height=this.canvas.height,o.putImageData(e,0,0),this.canvas.width=t.width,this.canvas.height=t.height,this.ctx.drawImage(i,0,0,t.width,t.height)}async analyzeImage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),o=100;e.width=o,e.height=o,i.drawImage(t,0,0,o,o);const n=i.getImageData(0,0,o,o).data;let a=0,s=0,r=0,h=0;const c=n.length/4;for(let t=0;t<n.length;t+=4){const e=n[t],i=n[t+1],o=n[t+2];a+=(e+i+o)/3;const c=Math.max(e,i,o),l=Math.min(e,i,o);s+=0===c?0:(c-l)/c,r+=e,h+=o}const l=a/c,d=s/c,u=r/c,g=h/c;let p=0,m=0,v=0,y="none";return l<80?p=15:l>200&&(p=-10),l>100&&l<180&&(m=15),d<.3&&(v=20),u>g+10&&d>.4?y="vibrant":g>u+10?y="warm":d<.2&&(y="vibrant"),{suggestedBrightness:p,suggestedContrast:m,suggestedSaturation:v,suggestedFilter:y,avgBrightness:l,avgSaturation:d}}generateFileName(t,e){return`edited-${Date.now()}-${Object.keys(e).join("-")}.jpg`}async batchEdit(t,e){this.logger.info(`Starting batch edit for ${t.length} photos`);const i=await Promise.all(t.map(t=>this.editPhoto(t,e)));return this.logger.info(`Batch edit completed for ${i.length} photos`),i}}class a{constructor(){this.logger=new o.Vy("PhotoEditorUI"),this.photoEditor=new n,this.currentPhoto=null,this.photos=[],this.currentPhotoIndex=0,this.zoomLevel=1,this.cropMode=!1,this.cropSelection=null,this.canvas=document.getElementById("editCanvas"),this.ctx=this.canvas.getContext("2d"),this.init()}async init(){this.logger.info("Initializing Photo Editor UI");try{this.setupEventListeners(),this.loadPhotosFromStorage(),this.updateUI(),this.logger.info("Photo Editor UI initialized successfully")}catch(t){this.logger.error("Failed to initialize photo editor:",t)}}setupEventListeners(){document.getElementById("backBtn")?.addEventListener("click",()=>this.goBack()),document.getElementById("autoEnhanceBtn")?.addEventListener("click",()=>this.autoEnhance()),document.getElementById("saveBtn")?.addEventListener("click",()=>this.saveCurrentPhoto()),this.setupSlider("brightnessSlider","brightnessValue","brightness"),this.setupSlider("contrastSlider","contrastValue","contrast"),this.setupSlider("saturationSlider","saturationValue","saturation"),document.getElementById("rotate90Btn")?.addEventListener("click",()=>this.rotate(90)),document.getElementById("rotate180Btn")?.addEventListener("click",()=>this.rotate(180)),document.getElementById("rotate270Btn")?.addEventListener("click",()=>this.rotate(270)),document.getElementById("cropBtn")?.addEventListener("click",()=>this.toggleCropMode()),document.querySelectorAll(".filter-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-filter");this.applyFilter(e),this.updateFilterUI(t)})}),this.setupResizeControls(),document.getElementById("createVariationsBtn")?.addEventListener("click",()=>this.createVariations()),document.getElementById("batchApplyBtn")?.addEventListener("click",()=>this.batchApplyCurrentSettings()),document.getElementById("resetBtn")?.addEventListener("click",()=>this.resetAllEdits()),document.getElementById("zoomInBtn")?.addEventListener("click",()=>this.zoomIn()),document.getElementById("zoomOutBtn")?.addEventListener("click",()=>this.zoomOut()),document.getElementById("fitToScreenBtn")?.addEventListener("click",()=>this.fitToScreen()),document.getElementById("addPhotosBtn")?.addEventListener("click",()=>this.addPhotos()),document.getElementById("photoFileInput")?.addEventListener("change",t=>this.handleFileSelection(t)),this.setupCanvasInteraction()}setupSlider(t,e,i){const o=document.getElementById(t),n=document.getElementById(e);o?.addEventListener("input",()=>{const t=parseInt(o.value);n&&(n.textContent=t.toString()),this.currentPhoto&&(this.currentPhoto.currentEdit[i]=t,this.applyCurrentEdits())})}setupResizeControls(){const t=document.getElementById("widthInput"),e=document.getElementById("heightInput"),i=document.getElementById("maintainAspectRatio"),o=document.getElementById("qualitySlider"),n=document.getElementById("qualityValue");let a=1;const s=()=>{this.currentPhoto&&t.value&&e.value&&(a=parseInt(t.value)/parseInt(e.value))};t?.addEventListener("input",()=>{if(i.checked&&e.value){const i=Math.round(parseInt(t.value)/a);e.value=i.toString()}this.updateResize()}),e?.addEventListener("input",()=>{if(i.checked&&t.value){const i=Math.round(parseInt(e.value)*a);t.value=i.toString()}this.updateResize()}),i?.addEventListener("change",()=>{i.checked&&s()}),o?.addEventListener("input",()=>{const t=parseInt(o.value);n&&(n.textContent=`${t}%`),this.updateResize()}),s()}updateResize(){if(!this.currentPhoto)return;const t=document.getElementById("widthInput"),e=document.getElementById("heightInput"),i=document.getElementById("qualitySlider");t.value&&e.value&&(this.currentPhoto.currentEdit.resize={width:parseInt(t.value),height:parseInt(e.value),quality:parseInt(i.value)/100},this.applyCurrentEdits())}setupCanvasInteraction(){let t=!1,e=0,i=0;this.canvas.addEventListener("mousedown",o=>{if(!this.cropMode)return;t=!0;const n=this.canvas.getBoundingClientRect();e=o.clientX-n.left,i=o.clientY-n.top,this.cropSelection={x:e,y:i,width:0,height:0},this.updateCropOverlay()}),this.canvas.addEventListener("mousemove",o=>{if(!t||!this.cropMode||!this.cropSelection)return;const n=this.canvas.getBoundingClientRect(),a=o.clientX-n.left,s=o.clientY-n.top;this.cropSelection.width=a-e,this.cropSelection.height=s-i,this.updateCropOverlay()}),this.canvas.addEventListener("mouseup",()=>{t&&this.cropMode&&this.cropSelection&&this.applyCrop(),t=!1})}async loadPhotosFromStorage(){try{const t=(await chrome.storage.local.get(["vehiclePhotos"])).vehiclePhotos||[];this.photos=t.map(t=>({originalUrl:t,currentImageData:t,editHistory:[],currentEdit:{}})),this.photos.length>0&&(this.currentPhotoIndex=0,this.currentPhoto=this.photos[0],await this.loadCurrentPhoto()),this.updatePhotosPanel()}catch(t){this.logger.error("Failed to load photos from storage:",t)}}async loadCurrentPhoto(){if(this.currentPhoto)try{this.showLoading(!0);const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{this.canvas.width=t.width,this.canvas.height=t.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(t,0,0),this.fitToScreen(),this.updateResizeInputs(t.width,t.height),this.showLoading(!1)},t.src=this.currentPhoto.currentImageData}catch(t){this.logger.error("Failed to load current photo:",t),this.showLoading(!1)}}async applyCurrentEdits(){if(this.currentPhoto)try{this.showLoading(!0);const t=await this.photoEditor.editPhoto(this.currentPhoto.originalUrl,this.currentPhoto.currentEdit);this.currentPhoto.currentImageData=t.editedDataUrl;const e=new Image;e.onload=()=>{this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e,0,0),this.showLoading(!1)},e.src=t.editedDataUrl}catch(t){this.logger.error("Failed to apply edits:",t),this.showLoading(!1)}}async autoEnhance(){if(this.currentPhoto)try{this.showLoading(!0);const t=await this.photoEditor.autoEnhance(this.currentPhoto.originalUrl);this.currentPhoto.currentEdit=t.editOptions,this.currentPhoto.currentImageData=t.editedDataUrl,this.updateControlsFromEdit(),await this.loadCurrentPhoto()}catch(t){this.logger.error("Auto enhance failed:",t),this.showLoading(!1)}}applyFilter(t){this.currentPhoto&&(this.currentPhoto.currentEdit.filter=t,this.applyCurrentEdits())}updateFilterUI(t){document.querySelectorAll(".filter-btn").forEach(t=>t.classList.remove("active")),t.classList.add("active")}rotate(t){this.currentPhoto&&(this.currentPhoto.currentEdit.rotation=((this.currentPhoto.currentEdit.rotation||0)+t)%360,this.applyCurrentEdits())}toggleCropMode(){this.cropMode=!this.cropMode;const t=document.getElementById("cropOverlay"),e=document.getElementById("cropBtn");this.cropMode?(t?.classList.remove("hidden"),e?.classList.add("active")):(t?.classList.add("hidden"),e?.classList.remove("active"),this.cropSelection=null)}updateCropOverlay(){if(!this.cropSelection)return;const t=document.querySelector(".crop-selection");t&&(t.style.left=`${Math.min(this.cropSelection.x,this.cropSelection.x+this.cropSelection.width)}px`,t.style.top=`${Math.min(this.cropSelection.y,this.cropSelection.y+this.cropSelection.height)}px`,t.style.width=`${Math.abs(this.cropSelection.width)}px`,t.style.height=`${Math.abs(this.cropSelection.height)}px`)}applyCrop(){if(!this.currentPhoto||!this.cropSelection)return;const t=this.canvas.getBoundingClientRect(),e=this.canvas.width/t.width,i=this.canvas.height/t.height;this.currentPhoto.currentEdit.crop={x:Math.min(this.cropSelection.x,this.cropSelection.x+this.cropSelection.width)*e,y:Math.min(this.cropSelection.y,this.cropSelection.y+this.cropSelection.height)*i,width:Math.abs(this.cropSelection.width)*e,height:Math.abs(this.cropSelection.height)*i},this.applyCurrentEdits(),this.toggleCropMode()}async createVariations(){if(this.currentPhoto)try{this.showLoading(!0);const t=await this.photoEditor.createVariations(this.currentPhoto.originalUrl);this.displayVariations(t),this.showLoading(!1)}catch(t){this.logger.error("Failed to create variations:",t),this.showLoading(!1)}}displayVariations(t){const e=document.getElementById("variationsSection"),i=document.getElementById("variationsGrid");e&&i&&(i.innerHTML="",t.forEach((t,e)=>{const o=document.createElement("div");o.className="variation-item",o.innerHTML=`\n        <img src="${t.editedDataUrl}" alt="Variation ${e+1}" class="variation-thumb">\n        <div class="variation-label">Variation ${e+1}</div>\n      `,o.addEventListener("click",()=>{this.currentPhoto&&(this.currentPhoto.currentEdit=t.editOptions,this.currentPhoto.currentImageData=t.editedDataUrl,this.updateControlsFromEdit(),this.loadCurrentPhoto())}),i.appendChild(o)}),e.classList.remove("hidden"))}async batchApplyCurrentSettings(){if(this.currentPhoto&&!(this.photos.length<=1))try{this.showLoading(!0);const t=this.photos.filter((t,e)=>e!==this.currentPhotoIndex).map(t=>t.originalUrl);(await this.photoEditor.batchEdit(t,this.currentPhoto.currentEdit)).forEach((t,e)=>{const i=e<this.currentPhotoIndex?e:e+1;this.photos[i].currentEdit=t.editOptions,this.photos[i].currentImageData=t.editedDataUrl}),this.updatePhotosPanel(),this.showLoading(!1)}catch(t){this.logger.error("Batch apply failed:",t),this.showLoading(!1)}}resetAllEdits(){this.currentPhoto&&(this.currentPhoto.currentEdit={},this.currentPhoto.currentImageData=this.currentPhoto.originalUrl,this.updateControlsFromEdit(),this.loadCurrentPhoto())}updateControlsFromEdit(){if(!this.currentPhoto)return;const t=this.currentPhoto.currentEdit;this.setSliderValue("brightnessSlider","brightnessValue",t.brightness||0),this.setSliderValue("contrastSlider","contrastValue",t.contrast||0),this.setSliderValue("saturationSlider","saturationValue",t.saturation||0),document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active"),e.getAttribute("data-filter")===(t.filter||"none")&&e.classList.add("active")})}setSliderValue(t,e,i){const o=document.getElementById(t),n=document.getElementById(e);o&&(o.value=i.toString()),n&&(n.textContent=i.toString())}updateResizeInputs(t,e){const i=document.getElementById("widthInput"),o=document.getElementById("heightInput");i&&(i.value=t.toString()),o&&(o.value=e.toString())}zoomIn(){this.zoomLevel=Math.min(1.2*this.zoomLevel,5),this.applyZoom()}zoomOut(){this.zoomLevel=Math.max(this.zoomLevel/1.2,.1),this.applyZoom()}fitToScreen(){const t=document.querySelector(".canvas-container");if(!t)return;const e=t.getBoundingClientRect(),i=(e.width-40)/this.canvas.width,o=(e.height-40)/this.canvas.height;this.zoomLevel=Math.min(i,o,1),this.applyZoom()}applyZoom(){this.canvas.style.transform=`scale(${this.zoomLevel})`;const t=document.querySelector(".zoom-level");t&&(t.textContent=`${Math.round(100*this.zoomLevel)}%`)}addPhotos(){const t=document.getElementById("photoFileInput");t?.click()}async handleFileSelection(t){const e=t.target.files;if(e&&0!==e.length){for(const t of Array.from(e))if(t.type.startsWith("image/")){const e=await this.fileToDataUrl(t),i={originalUrl:e,currentImageData:e,editHistory:[],currentEdit:{}};this.photos.push(i)}this.updatePhotosPanel(),!this.currentPhoto&&this.photos.length>0&&(this.currentPhotoIndex=0,this.currentPhoto=this.photos[0],await this.loadCurrentPhoto())}}fileToDataUrl(t){return new Promise((e,i)=>{const o=new FileReader;o.onload=()=>e(o.result),o.onerror=i,o.readAsDataURL(t)})}updatePhotosPanel(){const t=document.getElementById("photosList");t&&(t.innerHTML="",this.photos.forEach((e,i)=>{const o=document.createElement("div");o.className="photo-item "+(i===this.currentPhotoIndex?"active":""),o.innerHTML=`\n        <img src="${e.currentImageData}" alt="Photo ${i+1}" class="photo-thumb">\n        <div class="photo-info">\n          <div class="photo-name">Photo ${i+1}</div>\n          <div class="photo-size">Edited: ${Object.keys(e.currentEdit).length>0?"Yes":"No"}</div>\n        </div>\n        <div class="photo-actions">\n          <button class="btn btn-xs btn-tool" onclick="event.stopPropagation(); this.parentElement.parentElement.remove();">×</button>\n        </div>\n      `,o.addEventListener("click",()=>{this.currentPhotoIndex=i,this.currentPhoto=e,this.loadCurrentPhoto(),this.updateControlsFromEdit(),this.updatePhotosPanel()}),t.appendChild(o)}))}async saveCurrentPhoto(){if(this.currentPhoto)try{const t=document.createElement("a");t.download=`edited-photo-${Date.now()}.jpg`,t.href=this.currentPhoto.currentImageData,t.click(),this.logger.info("Photo saved successfully")}catch(t){this.logger.error("Failed to save photo:",t)}}goBack(){window.history.back()}showLoading(t){const e=document.getElementById("loadingIndicator");e&&(t?e.classList.remove("hidden"):e.classList.add("hidden"))}updateUI(){this.updatePhotosPanel(),this.currentPhoto&&this.updateControlsFromEdit()}}document.addEventListener("DOMContentLoaded",()=>{new a})}},i={};function o(t){var n=i[t];if(void 0!==n)return n.exports;var a=i[t]={exports:{}};return e[t](a,a.exports,o),a.exports}o.m=e,t=[],o.O=(e,i,n,a)=>{if(!i){var s=1/0;for(l=0;l<t.length;l++){for(var[i,n,a]=t[l],r=!0,h=0;h<i.length;h++)(!1&a||s>=a)&&Object.keys(o.O).every(t=>o.O[t](i[h]))?i.splice(h--,1):(r=!1,a<s&&(s=a));if(r){t.splice(l--,1);var c=n();void 0!==c&&(e=c)}}return e}a=a||0;for(var l=t.length;l>0&&t[l-1][2]>a;l--)t[l]=t[l-1];t[l]=[i,n,a]},o.d=(t,e)=>{for(var i in e)o.o(e,i)&&!o.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t={513:0};o.O.j=e=>0===t[e];var e=(e,i)=>{var n,a,[s,r,h]=i,c=0;if(s.some(e=>0!==t[e])){for(n in r)o.o(r,n)&&(o.m[n]=r[n]);if(h)var l=h(o)}for(e&&e(i);c<s.length;c++)a=s[c],o.o(t,a)&&t[a]&&t[a][0](),t[a]=0;return o.O(l)},i=self.webpackChunkworkspace=self.webpackChunkworkspace||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var n=o.O(void 0,[76],()=>o(130));n=o.O(n)})();
//# sourceMappingURL=photo-editor.js.map